#!/usr/bin/env node
const path = require("path");
const { spawn } = require("child_process");
const { SonarJSApi } = require("../lib/api");

const home = path.join(__dirname, "..", "lib");
const projectVersion = "0.1-SNAPSHOT"; // TODO make this dynamic somehow!
const jarFile = path.join(home, `sonarjs-cli-${projectVersion}.jar`);
const projectHome = process.cwd();

const api = new SonarJSApi();

const analyzer = spawn("java", [
  "-Djava.awt.headless=true",
  "-classpath",
  jarFile,
  `-Dsonarlint.home=${home}`,
  `-Dproject.home=${projectHome}`,
  `-DX`,
  "-Dorg.freemarker.loggerLibrary=none",
  "org.sonarjs.cli.Main",
  process.argv
]);

console.log(jarFile);
let result = "";

analyzer.stdout.on("data", data => {
  result += data.toString("utf8");
});

analyzer.stderr.on("data", data => {
  console.log(`stderr: ${data}`);
});

analyzer.on("close", code => {
  api.read(result);
  api.consoleLines().map(line => console.log(line));
});
